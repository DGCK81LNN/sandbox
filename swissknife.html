<!DOCTYPE HTML>
<html>
  <head>
    <meta charset=utf-8>
    <meta name=viewport content="width=device-width,initial-scale=1">
    <meta name=robots content="noindex">
    <title>
      LNN's swiss-knife util
    </title>
    <style>
      button{
        padding:4px 8px;
      }
      #textAndOut {
        display: flex;
        flex-wrap: wrap;
      }
      #textAndOut textarea {
        flex: 1;
        min-width: 267px;
        height: 300px;
        resize: none;
      }
    </style>
    <link rel=stylesheet href="https://cdn.bootcdn.net/ajax/libs/codemirror/5.58.3/codemirror.css">
    <script src="https://cdn.bootcdn.net/ajax/libs/codemirror/5.58.3/codemirror.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/codemirror/5.58.3/mode/javascript/javascript.min.js"></script>
    <script src="https://dgck81lnn.github.io/js/utils.js"></script>
  </head>
  <body>
    <h1>
      LNN's swiss-knife util
    </h1>
    <div id=codeDiv>
      <div id=codeToolbarDiv>
        <button id=btn-cm-selectall>select all</button>
        <button id=btn-cm-undo>undo</button>
        <button id=btn-cm-redo>redo</button>
        <button id=btn-cm-tab>tab</button>
      </div>
    </div>
    <div style="margin:8px 0">
      <div>
        out &larr;
        <button id=btn-eval>eval code</button>
        <button id=btn-codepoints>code point escape text</button>
        <button id=btn-dump>dump code &amp; text</button>
      </div>
      <div>
        out &larr; utf-8 + base64
        <button id=btn-b64e>encode</button>
        <button id=btn-b64d>decode</button>
        text
      </div>
      <div>
        out &larr; uri-component
        <button id=btn-urie>encode</button>
        <button id=btn-urid>decode</button>
        text
      </div>
      <div>
        out &larr; html
        <button id=btn-htmlentec>escape &amp;&lt;&gt;</button>
        <button id=btn-htmlented>escape &amp;"</button>
        <button id=btn-htmlentes>escape &amp;'</button>
        <button id=btn-htmlentd>unescape</button>
        text
      </div>
      <div>
        out &larr; read
        <button id=btn-file>#file</button>
        as
        <button id=btn-filet>text</button>
        <button id=btn-filed>data url</button>
        |
        <button id=btn-fileb>to object url</button>
      </div>
      <div>
        swap
        <button id=btn-swapco>code, out</button>
        <button id=btn-swapto>text, out</button>
        <button id=btn-swapct>code, text</button>
      </div>
    </div>
    <div id=textAndOut>
      <textarea id=text placeholder="#text"></textarea>
      <textarea id=out placeholder="#out" readonly></textarea>
    </div>
    <fieldset id=myDivWrapper><legend>#myDiv</legend>
      <div id=myDiv></div>
    </fieldset>
    <input type=file id=file style="display:none">
    <script>
      function $$$(id) { return document.getElementById(id) }
      ;(function (){
        const codeCm = new CodeMirror($$$("codeDiv"), {
          lineNumbers: true,
          lineWrapping: true,
          indentUnit: 2
        })
        const $code = window.codebox = {
          get value() {
            return codeCm.getValue()
          },
          set value(v) {
            codeCm.setValue(v)
          },
          CodeMirror: codeCm
        }

        const $text = window.text = $$$("text")
        const $out = window.out = $$$("out")
        const $myDiv = window.myDiv = $$$("myDiv")
        const $file = window.file = $$$("file")

        const SoulLS = window.SoulLS = {
          $code: $code,
          get code() {
            return codeCm.getValue()
          },
          set code(val) {
            codeCm.setValue(String(val))
          },
          $text: $text,
          get text() {
            return $text.value
          },
          set text(val) {
            $text.value = String(val)
          },
          $out: $out,
          get out() {
            return $out.value
          },
          set out(val) {
            showEvalOut = false
            let out = String(val)
            if (val instanceof Error) out += "\n\n" + val.stack
            $out.value = out
          },
          $file: $file,
          get file() {
            return $file.files[0]
          },
          $myDiv: $myDiv,
          myDiv: $myDiv,
          dump: dump
        }

        function addAction(id, handler) {
          $$$("btn-" + id).addEventListener("click", () => { handler() })
        }

        addAction("cm-selectall", () => {
          codeCm.focus()
          codeCm.execCommand('selectAll')
        })
        addAction("cm-undo", () => {
          codeCm.focus()
          codeCm.execCommand('undo')
        })
        addAction("cm-redo", () => {
          codeCm.focus()
          codeCm.execCommand('redo')
        })
        addAction("cm-tab", () => {
          codeCm.focus()
          codeCm.execCommand('defaultTab')
        })

        var showEvalOut = true
        const evalFunc = new Function("__code", "return eval(__code)")
        const AsyncFunction = (async function () {}).constructor
        let evalNonce = 0
        addAction("eval", () => {
          SoulLS.out = ""
          const code = SoulLS.code

          let useEval = true
          try {
            evalFunc('throw Symbol.for("@@__SOULLS_EVAL_OK__@@");' + code)
          } catch (err) {
            if (err !== Symbol.for("@@__SOULLS_EVAL_OK__@@")) useEval = false
          }

          showEvalOut = true
          try {
            if (useEval) {
              let result = evalFunc(code)
              if (showEvalOut) SoulLS.out = result
            } else {
              const nonce = ++evalNonce
              const promise = new AsyncFunction(code)()
              promise.then((result) => {
                if (showEvalOut && evalNonce === nonce) SoulLS.out = result
              }, (err) => {
                SoulLS.out = err
              })
              if (showEvalOut) {
                SoulLS.out = String(promise)
                showEvalOut = true
              }
            }
          } catch (err) {
            SoulLS.out = err
          }
        })

        function codePointToEscape(cp) {
          let hex = cp.toString(16)
          let len = hex.length
          if (cp === 0) return "\\0"
          if (len === 1) return `\\x0${hex}`
          if (len === 2) return `\\x${hex}`
          if (len === 3) return `\\u0${hex}`
          if (len === 4) return `\\u${hex}`
          return `\\u{${hex}}`
        }
        addAction("codepoints", () => {
          var s = ""
          for (let chara of SoulLS.text)
            s += codePointToEscape(chara.codePointAt(0))
          SoulLS.out = `"${s}"`
        })
        
        function dump() {
          let restorer = "", data = ""
          let text = SoulLS.text, code = SoulLS.code
          if (text) {
            restorer += "SoulLS.text=SoulLS.code.match(/\\/\\*BEGIN TEXT\\/\\*\\n([^]*?)\\n\\/\\*END TEXT\\*\\//)[1].replace(/\\/[\\\\]+(?=\\*)|\\*[\\\\]+(?=\\/)/g, s=>s[0]+s.slice(2));"
            data +=
              "/*BEGIN TEXT/*\n" +
              text.replace(/\/[\\]*(?=\*)|\*[\\]*(?=\/)/g, e => `${e[0]}\\${e.slice(1)}`) +
              "\n/*END TEXT*/\n"
          }
          if (code) {
            restorer += "SoulLS.code=SoulLS.code.match(/\\/\\*BEGIN CODE\\*\\/\\n([^]*)/)[1];"
            data += "/*BEGIN CODE*/\n" + code
          }
          return "/*SoulLS dump*/" + restorer + 'throw"";\n' + data
        }

        addAction("dump", () => {
          SoulLS.out = dump()
        })

        addAction("b64e", () => {
          SoulLS.out = Base64LNN.encodeUTF8(SoulLS.text)
        })
        addAction("b64d", () => {
          SoulLS.out = Base64LNN.decodeUTF8(SoulLS.text)
        })

        addAction("urie", () => {
          SoulLS.out = encodeURIComponent(SoulLS.text)
        })
        addAction("urid", () => {
          SoulLS.out = decodeURIComponent(SoulLS.text)
        })

        addAction("htmlentec", () => {
          SoulLS.out = SoulLS.text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
        })
        addAction("htmlented", () => {
          SoulLS.out = SoulLS.text.replace(/&/g,'&amp;').replace(/"/g,'&quot;')
        })
        addAction("htmlentes", () => {
          SoulLS.out = SoulLS.text.replace(/&/g,'&amp;').replace(/'/g,'&apos;')
        })
        addAction("htmlentd", () => {
          let $e = document.createElement("div")
          SoulLS.out = SoulLS.text.replace(/&\w[\d\w]+;?|&#\d+;?|&#x[\dA-Fa-f]+;?/g, c => {
            $e.innerHTML = c
            return $e.textContent
          })
        })

        addAction("file", () => {
          file.click()
        })
        addAction("filet", () => {
          var r = new FileReader()
          r.onload = () => {
            SoulLS.out = r.result
            r.onload = null
          }
          r.readAsText(file.files[0])
        })
        addAction("filed", () => {
          var r = new FileReader()
          r.onload = () => {
            SoulLS.out = r.result
            r.onload = null
          }
          r.readAsDataURL(file.files[0])
        })
        addAction("fileb", () => {
          SoulLS.out = window.URL.createObjectURL(SoulLS.file)
        })

        addAction("swapco", () => {
          ;[SoulLS.code, SoulLS.out] = [SoulLS.out, SoulLS.code]
        })
        addAction("swapto", () => {
          ;[SoulLS.text, SoulLS.out] = [SoulLS.out, SoulLS.text]
        })
        addAction("swapct", () => {
          ;[SoulLS.code, SoulLS.text] = [SoulLS.text, SoulLS.code]
        })
      })()
    </script>
  </body>
</html>
